---
title: "Raport for plate: `r paste0('*', params$plate$plate_name, '*')`"
output: html_document
params:
  plate: !r NULL
  use_model: TRUE
---

```{r param-check, echo=FALSE}
if (is.null(params$plate)) {
  stop("The `plate` must be provided when rendering the document.")
}
if (!is(params$plate, "Plate")) {
  stop("The `plate` must be an instance of `Plate` class.")
}
```

Report generated on  `r format(Sys.time(), "%d-%m-%Y %H:%M:%S")`.  
Plate was run on: `r if(!is.null(params$plate$experiment_time)) params$plate$experiment_time else "Date of running plate was not found in Luminex file"`.  
Plate batch name: `r if(!is.null(params$plate$batch_name)) params$plate$batch_name else "Batch name was not found in Luminex file"`.  
This is plate with `r paste0(length(params$plate$sample_names), " samples and ", length(params$plate$analyte_names), " analytes")`.


-------------------


### Plate layout

<details open>
  <summary>Click to show/hide layout</summary>
```{r plate-layout, fig.width=7, fig.height=4, fig.align='center', dev='jpeg', echo=FALSE, dpi=72}
plot_layout(params$plate)
```
</details>


------------------

### Quick overview of standard curves

<details open>
  <summary>Click to show/hide overview</summary>
```{r standard-curves-overview, results='asis', echo=FALSE, message=FALSE, warning=FALSE, out.width="20%", dev='jpeg', dpi=72}
# Code used to create dynamic tabs based on the number of analytes
for (i in 1:length(params$plate$analyte_names)) {
  
  # this part is hack
  cat(paste0('<a href="#', tolower(params$plate$analyte_names[i]), '" role="tab" data-toggle="tab" aria-controls="', tolower(params$plate$analyte_names[i]), '" aria-expanded="false">'))
  
  # generating of plot
  model <- create_standard_curve_model_analyte(params$plate, params$plate$analyte_names[i])
  print(plot_standard_curve_analyte_with_model(params$plate, model, plot_legend = FALSE))
  cat(paste0('</a>'))
}
```
</details>

------------------
 
### Details for given analayte {.tabset}

```{r quality-control, results='asis', echo=FALSE, message=FALSE, out.width="50%", dev='jpeg', dpi=72}
# Code used to create dynamic tabs based on the number of analytes
for (i in 1:length(params$plate$analyte_names)) {
  cat(paste0("#### ", params$plate$analyte_names[i], "\n"))

  # Plot counts
  print(plot_counts(params$plate, params$plate$analyte_names[i]))

  # Plot MFI
  print(plot_mfi_for_analyte(params$plate, params$plate$analyte_names[i], plot_type = "violin"))

  # Plot Standard Curve
  print(plot_standard_curve_analyte(params$plate, params$plate$analyte_names[i]))
  if (params$use_model) {
    model <- create_standard_curve_model_analyte(params$plate, params$plate$analyte_names[i])
    print(plot_standard_curve_analyte_with_model(params$plate, model))
  }

  cat("\n\n")
}
```

------------------

### &nbsp;

<hr />
<p style="text-align: center;">Generated using the <a href="https://github.com/mini-pw/PvSTATEM">PvSTATEM </a> package </p>



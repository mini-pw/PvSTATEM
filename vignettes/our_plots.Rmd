---
title: "Quick introduction to plots created by our package"
author: "Mateusz Nizwantowski"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
vignette: >
  %\VignetteIndexEntry{Quick introduction to plots created by our package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteDepends{ggplot2}
  %\VignetteDepends{nplr}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = FALSE,
  comment = "#>",
  warning = FALSE,
  message = FALSE
)
```

# Introduction

The `PvSTATEM` package provides a variety of plots that can be used to visualize the Luminex data. In this vignette, we will show how to use them. 
To present the package's functionalities, we use a sample dataset from the Covid OISE study, which is pre-loaded into the package. 
Firstly, let us load the dataset as the `plate` object.

```{r}
library(PvSTATEM)

plate_filepath <- system.file("extdata", "CovidOISExPONTENT.csv", package = "PvSTATEM", mustWork = TRUE) # get the filepath of the csv dataset

layout_filepath <- system.file("extdata", "CovidOISExPONTENT_layout.xlsx", package = "PvSTATEM", mustWork = TRUE)


plate <- read_luminex_data(plate_filepath, layout_filepath) # read the data

plate
```


# Plate layout
In this vignette, we will omit some validation functionality and focus on the plots. 
After the plate is successfully loaded, we should validate it by looking at some basic information about it using the summary function.
However, we can also obtain similar information in a more visual way by using the `plot_layout` function.
It helps to quickly asses whether the layout of the plate is correctly read from Luminex or the layout file.
The function takes the `plate` object as the argument.

```{r}
plot_layout(plate)
```

The plot above shows the layout of the plate. The wells are colored according to the type of the sample. 
If user is familiar with color scheme of this package, there is an option to disable legend. 
This can be done by setting `show_legend` parameter to `FALSE`.

If plot window is resized, it is recomended to rerun the function to adjust the scaling of the plot.
Sometimes when legend is plotted, whole layout may be shifted, in order to solve this issue one has to stretch the window in the direction of layout shift, and everything will be adjusted automatically.

# Counts for given analyte
The `plot_counts` function allows to visualize the counts of the analyte in the plate. 
This plot is useful to quickly spot wells with too low count.
The function takes the `plate` object and the analyte name as the arguments.
If there is typo in the analyte name, the function will return an error message.

```{r}
plot_counts(plate, "Spike_B16172")
```

The plot above shows the counts of the analyte "OC43_NP_NA" in the plate. The wells are colored according to the count of the analyte.
Too low values are marked with red color, values on the edge of the threshold are marked with yellow color, and the rest are marked with green color.
There is an option to show legend by setting `show_legend` parameter to `TRUE`.
There is also an option to show just the colors without the counts by setting `show_counts` parameter to `FALSE`.
This provides a cleaner plot, without the counts.

```{r}
plot_counts(plate, "FluA", plot_counts = FALSE)
```

# Distribution of MFI values

The `plot_mfi_distribution` function allows to visualize the distribution of the MFI values for test samples for the given analyte. And how they compare to standard curve samples on a given plate.
This plot is useful to asses if the standard curve samples cover the whole range of MFI of test samples.
The function takes the `plate` object and the analyte name as the arguments. 
If there is typo in the analyte name, the function will return an error message.

```{r}
plot_mfi_for_analyte(plate, "Spike_B16172")
```

This plot shows the distribution of the MFI values for test samples for the analyte "OC43_NP_NA". The test samples are colored in blue, and the standard curve samples are colored in red.
Deafult plot type is boxplot, but there is an option to change it to violin plot by setting `plot_type` parameter to `violin`.

```{r}
plot_mfi_for_analyte(plate, "FluA", plot_type = "violin")
```


# Standard curve plots


Finaly we arrive at the the most important visualization in our package - the standard curve related plots.
Those plot are useful to asses the quality of the fit which will be crucial to us in the next step of development of the package.
It comes in two flavours: `plot_standard_curve_analyte` and `plot_standard_curve_analyte_with_model`.
The first one does not incorporate the model, while the second one does.

## Standard curve plot without model


This plot should be used to asses the quality of the assay.
If anything went wrong during the preparation of the plate, it should be visible easily in this plot.

```{r}
plot_standard_curve_analyte(plate, "Spike_B16172")
```

Above we see the default plot for the analyte "Spike_B16172". We can modify this plot by setting the parameters of the function.
For example, we can change the direction of x axis by setting `decreasing_dilution_order` parameter to `FALSE`.
Other parameters worth mentioning are `log_scale`, default value is `c("all")`, which means that both x and y axis are in log scale.
Other possible values for this parameter are `c("dilutions")` and `c("MFI")` which means that only x or y axis is in log scale.
There is also an option to disable some parts of the plot by setting parameters `plot_line`, `plot_blank_mean` and `plot_dilution_bounds` to `FALSE`.
First one disables drawing the line between standard curve points, second one disables plotting the mean of blank samples, and the last one disables plotting the dilution bounds.

## Standard curve plot with model

This visualization is similar to the previous one, but it also incorporates the model.
Thus it caries more information, at the cost of being more complex, and crowded.

```{r}
model <- create_standard_curve_model_analyte(plate, analyte_name = "Spike_B16172")
plot_standard_curve_analyte_with_model(plate, model)
```

Here we do not have to specify the analyte name, as the model is already caries this information.
The model is created by the `create_standard_curve_model_analyte` function, which takes the `plate` object and the analyte name as the arguments, but this is not the focus of this vignette.
The arguments of this function are very similar to the previos one, except here there is missing `plot_line' argument, and there are two new arguments: `plot_asymptote` and `plot_test_predictions`.
The first one disables plotting the asymptotes, and the second one disables plotting the predictions for the test samples.
By default, both are set to `TRUE`.
